var numPath = [
    /* 0 */"",
    /* 1 */"M8.954 30V3.545h-.267c-.738.41-6.706 4.655-7.71 5.311V5.883c.635-.41 6.767-4.758 7.977-5.476h2.789V30h-2.79z",
    /* 2 */"M.12 9.57C.16 4.462 4.057.791 9.41.791c5.209 0 9.187 3.568 9.187 8.224 0 3.076-1.415 5.475-6.275 10.664l-7.998 8.53v.247h15.012V31H.284v-1.969L10.62 17.854c4.122-4.43 5.168-6.193 5.168-8.736 0-3.302-2.81-5.865-6.44-5.865-3.814 0-6.46 2.584-6.5 6.316v.02H.12v-.02z",
    /* 3 */"M6.698 16.932v-2.42h3.466c3.814 0 6.46-2.338 6.46-5.722 0-3.22-2.646-5.537-6.317-5.537-3.67 0-6.255 2.174-6.542 5.537H1.038C1.366 3.95 5.037.792 10.41.792c5.045 0 9.064 3.404 9.064 7.67 0 3.568-2.05 6.173-5.496 6.932v.266c4.225.472 6.85 3.281 6.85 7.342 0 4.86-4.491 8.613-10.295 8.613-5.722 0-9.926-3.404-10.11-8.182H3.13c.246 3.322 3.322 5.721 7.382 5.721 4.286 0 7.424-2.645 7.424-6.214 0-3.711-2.912-6.008-7.65-6.008H6.699z",
    /* 4 */"M15.855 30v-6.686H.987v-2.563C3.633 16.281 7.283 10.6 14.563.366h4.02v20.426h4.43v2.522h-4.43V30h-2.728zM3.92 20.628v.184h11.935V3.052h-.184C10.03 10.744 7.099 15.338 3.92 20.629z",
    /* 5 */"M10.553 30.615c-5.373 0-9.474-3.445-9.782-8.264H3.52c.308 3.322 3.322 5.783 7.055 5.783 4.327 0 7.424-3.097 7.424-7.445 0-4.347-3.097-7.444-7.363-7.444-2.912 0-5.496 1.415-6.747 3.692H1.222l1.6-16.53h16.14V2.93H5.037l-.985 10.787h.267c1.415-1.846 3.876-2.912 6.768-2.912 5.68 0 9.72 4.08 9.72 9.802 0 5.866-4.245 10.008-10.254 10.008z",
    /* 6 */"M10.964 31.595c-4 0-7.158-1.99-9.003-5.64C.648 23.638-.01 20.582-.01 16.83-.008 6.76 4.135.792 11.17.792c4.901 0 8.613 2.953 9.454 7.567h-2.871c-.739-3.076-3.323-5.045-6.624-5.045-5.312 0-8.347 4.963-8.409 13.74h.246c1.292-3.322 4.553-5.454 8.43-5.454 5.618 0 9.76 4.183 9.76 9.843 0 5.886-4.285 10.152-10.191 10.152zm-.041-2.482c4.204 0 7.403-3.281 7.403-7.567 0-4.368-3.097-7.506-7.383-7.506-4.225 0-7.485 3.158-7.485 7.3 0 4.41 3.24 7.773 7.465 7.773z",
    /* 7 */"M3.017 30L16.696 3.155V2.93H.29V.407h19.277v2.625L6.01 30z",
    /* 8 */"M10.533 31.615c-6.193 0-10.48-3.527-10.48-8.593 0-3.834 2.584-6.87 6.46-7.567v-.246c-3.22-.759-5.311-3.343-5.311-6.583 0-4.573 3.876-7.834 9.33-7.834 5.456 0 9.332 3.24 9.332 7.834 0 3.22-2.071 5.804-5.291 6.583v.246c3.855.697 6.46 3.732 6.46 7.567 0 5.086-4.286 8.593-10.5 8.593zm0-2.42c4.532 0 7.67-2.604 7.67-6.357 0-3.671-3.117-6.173-7.67-6.173-4.532 0-7.65 2.523-7.65 6.173 0 3.753 3.118 6.357 7.65 6.357zm0-14.95c3.896 0 6.562-2.174 6.562-5.393 0-3.343-2.666-5.64-6.562-5.64-3.897 0-6.563 2.297-6.563 5.64 0 3.199 2.666 5.393 6.563 5.393z",
    /* 9 */"M10.897 31.595c-4.983 0-8.613-2.974-9.454-7.547h2.871c.718 3.015 3.22 5.045 6.624 5.045 5.23 0 8.203-4.779 8.408-13.064.02-.205-.102-.471-.123-.676H19.1c-1.271 3.26-4.552 5.434-8.428 5.434-5.66 0-9.762-4.163-9.762-9.803C.91 5.1 5.175.792 11.102.792c4 0 7.157 2.01 9.003 5.68 1.313 2.298 1.969 5.333 1.969 9.106 0 10.028-4.102 16.017-11.177 16.017zm.226-13.248c4.245 0 7.485-3.2 7.485-7.28 0-4.39-3.22-7.794-7.465-7.794-4.224 0-7.403 3.302-7.403 7.63 0 4.285 3.035 7.444 7.383 7.444z"
];

var sl = {

    // Sudoku solver
    solveSudoku: function (board, max) {
        const solutions = [];
        this.solve(board, solutions, max ?? 20);
        return solutions;
    },

    solve: function (board, solutions, max) {
        const emptySpot = this.findEmptySpot(board);
        if (!emptySpot) {
            solutions.push(this.copyBoard(board));
            return true; // All spots filled, puzzle solved
        }

        const [row, col] = emptySpot;

        for (let num = 1; num <= 9; num++) {
            if (this.isValid(board, row, col, num)) {
                board[row][col] = num;
                if (this.solve(board, solutions, max)) {
                    if (solutions.length >= max) {
                        return true;
                    }
                }
                board[row][col] = 0;
            }
        }

        return false; // No valid number found
    },

    // 将输入的数独数据进行校验
    check: function (base, r, c, num) {
        if (!this.isValid(base, r, c, num)) {
            return false;
        }

        var d = this.copyBoard(base);
        d[r][c] = num;

        return this.solveSudoku(d, 1).length > 0;
    },

    findEmptySpot: function (board) {
        for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
                if (board[row][col] === 0) {
                    return [row, col];
                }
            }
        }
        return null; // No empty spot found
    },

    isValid: function (board, row, col, num) {
        return (
            this.isRowValid(board, row, num) &&
            this.isColValid(board, col, num) &&
            this.isBoxValid(board, row - (row % 3), col - (col % 3), num)
        );
    },

    isRowValid: function (board, row, num) {
        for (let col = 0; col < 9; col++) {
            if (board[row][col] === num) {
                return false;
            }
        }
        return true;
    },

    isColValid: function (board, col, num) {
        for (let row = 0; row < 9; row++) {
            if (board[row][col] === num) {
                return false;
            }
        }
        return true;
    },

    isBoxValid: function (board, startRow, startCol, num) {
        for (let row = 0; row < 3; row++) {
            for (let col = 0; col < 3; col++) {
                if (board[row + startRow][col + startCol] === num) {
                    return false;
                }
            }
        }
        return true;
    },

    copyBoard: function (board) {
        return board.map(row => row.slice());
    }
};

class Cell {
    constructor(row, col, num) {
        this.orgNum = num ?? 0;
        if (this.orgNum < 0 || this.orgNum > 9) {
            this.orgNum = 0;
        }
        this.row = row;
        this.col = col;
        this.value = this.orgNum;
        this.sure = false;
        this.pencil = new Array(10).fill(false);

        this.cell = document.getElementById(`r${row}c${col}`);
        if (this.orgNum > 0 && this.orgNum < 10) {
            this.cell.className = 'game-cell gv';
        }
        else {
            this.cell.className = 'game-cell';
        }

        this.render();
    }

    dump() {
        return {
            row: this.row,
            col: this.col,
            value: this.value,
            orgNum: this.orgNum,
            sure: this.sure,
            pencil: this.pencil,
            className: this.cell.className
        };
    }

    restore(data) {
        this.row = data.row;
        this.col = data.col;
        this.value = data.value;
        this.orgNum = data.orgNum;
        this.sure = data.sure;
        this.pencil = data.pencil;
        this.cell = document.getElementById(`r${this.row}c${this.col}`);
        this.cell.className = data.className;
        this.render();
    }

    render() {
        if (this.value == 0) {
            var html = '<div class="cell-value"></div>';
            var pencilHtml = `<div class="pencil-grid${this.sure ? ' sure' : ''}">`;
            var pencilCount = 0;
            for (var i = 1; i < 10; i++) {
                pencilHtml += `<div class="pencil-grid-cell pgc-${i}">`;
                if (this.pencil[i]) {
                    pencilCount++;

                    pencilHtml += '<svg width="20" height="31" viewBox="0 0 20 31.4">';
                    pencilHtml += `<path d="${numPath[i]}"></path>`;
                    pencilHtml += '</svg>';
                }
                pencilHtml += '</div>';
            }
            pencilHtml += '</div>'
            if (pencilCount > 0) {
                html += pencilHtml;
            }
            this.cell.innerHTML = html;
        }
        else {
            var html = '<div class="cell-value">';
            html += '<svg width="23" height="32" viewBox="0 0 23 32">';
            html += `<path d="${numPath[this.value]}"></path>`;
            html += '</svg>';
            html += '</div>';
            this.cell.innerHTML = html;
        }
    }

    addClass(className) {
        if (!this.cell.classList.contains(className)) {
            this.cell.classList.add(className);
        }
    }

    removeClass(className) {
        this.cell.classList.remove(className);
    }

    setTips(tips, type) {
        var className = 'cell-tips';
        if (type == 2) {
            className = 'cell-tips-same';
        }
        else if (type == 3) {
            className = 'cell-err';
        }

        if (tips) {
            this.addClass(className);
        }
        else {
            this.removeClass(className);
        }
    }

    setSelected(selected) {
        if (selected) {
            this.addClass('cell-selected');
        }
        else {
            this.removeClass('cell-selected');
        }
    }

    isSelected() {
        return true == this.cell.classList.contains('cell-selected');
    }

    setValue(num) {
        if (this.orgNum > 0) {
            // 有初始值不能修改
            return;
        }

        if (num < 0 || num > 9) {
            num = 0;
        }

        this.value = num;
        this.render();
    }

    getValue() {
        return this.value;
    }

    setPencil(num) {
        if (num < 0 || num > 9) {
            num = 0;
        }

        if (this.value != 0) {
            // 确定的值，不能做笔记
            return;
        }

        this.pencil[num] = true;
        this.render();
    }

    delPencil(num) {
        if (num < 0 || num > 9) {
            num = 0;
        }

        this.pencil[num] = false;
        this.render();
    }

    clearPencil() {
        for (var i = 0; i < 10; i++) {
            this.pencil[i] = false;
        }
        this.render();
    }

    hasPencil() {
        for (var i = 0; i < 9; i++) {
            if (this.pencil[i]) {
                return true;
            }
        }
        return false;
    }

    isPencil(num) {
        if (num < 0 || num > 9) {
            num = 0;
        }
        return this.pencil[num];
    }

    getPencil() {
        return this.pencil;
    }

    makeSure(sure) {
        this.sure = sure;
        this.render();
    }

}

var sudoku = {
    base: [],
    cells: [],  // 保存所有格子元素的数组
    history: [],
    historyIndex: 0,
    isMouseDown: false,
    eventListened: false,

    init: function (gameData) {
        this.cells = this.sudokuArray();
        this.base = gameData;
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        for (var r = 0; r < 9; ++r) {
            for (var c = 0; c < 9; ++c) {
                this.cells[r][c] = new Cell(r, c, gameData[r][c]);
                if (isMobile == false && false == this.eventListened) {
                    this.listenEvent(this.cells[r][c].cell);
                }
            }
        }

        if (isMobile && false == this.eventListened) {
            let elm = document.getElementById("gameTable");
            elm.addEventListener('touchstart', (e) => {
                // 获取触摸点的信息
                let touch = event.touches[0];
                let element = document.elementFromPoint(touch.clientX, touch.clientY);
                this.mouseDown({ target: element })
            });
            elm.addEventListener('touchend', (e) => {
                this.mouseUp(e)
            });
            elm.addEventListener('touchmove', (e) => {
                e.preventDefault();

                // 获取触摸点的信息
                let touch = event.touches[0];
                let element = document.elementFromPoint(touch.clientX, touch.clientY);
                while (element && !element.classList.contains('game-cell')) {
                    element = element.parentNode;
                }

                // 对比是否跟上一次的元素相同
                if (element === this.lastElement) {
                    return;
                }
                this.lastElement = element;

                this.mouseEnter({ target: element });
            });
        }
        this.eventListened = true;
        this.dump();
    },

    mouseDown: function (e) {
        var div = e.target;
        while (div && !div.classList.contains('game-cell')) {
            div = div.parentNode;
        }
        if (!div) {
            return;
        }
        // 取id并分析出r和c
        var id = div.id;
        var r = parseInt(id.substr(1, 1));
        var c = parseInt(id.substr(3, 1));

        this.isMouseDown = true;

        if (document.getElementById('autoSel').checked) {
            this.cells[r][c].setSelected(false == this.cells[r][c].isSelected());
        }
        else {
            this.cells.forEach(row => {
                row.forEach(cell => {
                    cell.setSelected(cell.cell.id == div.id);
                });
            });
        }

        if (this.cells[r][c].isSelected()) {
            this.updateTips(r, c);
        }
        else {
            this.updateTips(-1, -1);
        }
    },

    mouseEnter: function (e) {
        var div = e.target;
        while (div && !div.classList.contains('game-cell')) {
            div = div.parentNode;
        }

        var id = div.id;
        var r = parseInt(id.substr(1, 1));
        var c = parseInt(id.substr(3, 1));


        if (false == this.isMouseDown) {
            return;
        }

        if (document.getElementById('autoSel').checked) {
            this.cells[r][c].setSelected(false == this.cells[r][c].isSelected());
        }
        else {
            this.cells[r][c].setSelected(true);
        }
    },

    mouseUp: function (e) {
        this.isMouseDown = false;
    },

    listenEvent: function (elm) {
        elm.addEventListener('mousedown', (e) => this.mouseDown(e));
        elm.addEventListener('mouseenter', (e) => this.mouseEnter(e));
        elm.addEventListener('mouseup', (e) => this.mouseUp(e));
    },

    strToSudokuArray: function (str) {
        var arr = this.sudokuArray(0);

        var s = [
            /\!/g, /\@/g, /\#/g, /\$/g, /\%/g, /\^/g, /\&/g, /\*/g,
            /\(/g, /\)/g, /\-/g, /\=/g
        ];

        str = str.replace(/\{(\d+)\}/ig,
            (_, m) => {
                return '0'.repeat(m);
            }
        );

        str = str.replace(/\|([0-9a-z])/ig,
            (_, m) => {
                var c = m.toLowerCase().charCodeAt(0);
                if (c >= 48 && c <= 57) {
                    c -= 48;
                } else if (c >= 97 && c <= 122) {
                    c -= 87;
                } else {
                    return '';
                }
                return '0'.repeat(c);
            }
        );

        for (var i = 0; i < s.length; i++) {
            str = str.replace(s[i], '0'.repeat(i + 1));
        }

        for (var i = 0; i < str.length; i++) {
            var row = Math.floor(i / 9);
            if (row > 8) {
                break;
            }
            var col = i % 9;
            if (str[i] < '0' || str[i] > '9') {
                arr[row][col] = 0;
            }
            else {
                arr[row][col] = parseInt(str[i]);
            }
        }
        return arr;
    },

    // 返回一个9*9的空数组
    sudokuArray: function (fill) {
        var data = new Array(9);
        for (var i = 0; i < 9; i++) {
            if (fill) {
                data[i] = new Array(9).fill(fill);
            } else {
                data[i] = new Array(9);
            }
        }
        return data;
    },

    getData: function () {
        var data = this.sudokuArray();
        for (var i = 0; i < 81; i++) {
            var row = parseInt(i / 9);
            var col = i % 9;
            data[row][col] = this.cells[row][col].value;
        }
        return data;
    },

    getStr: function () {
        var str = '';
        var t = '!@#$%^&*()-=';
        var c = 0;
        for (var i = 0; i < 81; i++) {
            var row = parseInt(i / 9);
            var col = i % 9;
            num = this.cells[row][col].value;
            if (num == 0) {
                c++;
                if (c == 12) {
                    str += '=';
                    c = 0;
                }
                continue;
            }

            if (c > 0) {
                str += t.substring(c - 1, c);
                c = 0;
            }

            str += num;
        }
        if (c > 0) {
            str += t.substring(c - 1, c);
            c = 0;
        }

        return str;
    },

    solve: function () {
        var res = sl.solveSudoku(this.getData());
        if (!res || res.length == 0) {
            console.log("No solution found");
            return;
        }

        // 随机取一个解
        var data = res[Math.floor(Math.random() * res.length)];

        for (var r = 0; r < 9; r++) {
            for (var c = 0; c < 9; c++) {
                this.cells[r][c].setValue(data[r][c] ?? 0);
            }
        }
        this.dump();
    },

    setValue: function (num) {
        var rec = [];
        // var b = this.base;
        var b = this.getData();
        this.cells.forEach((row, r) => {
            row.forEach((cell, c) => {
                if (cell.isSelected() && cell.orgNum == 0) {
                    cell.setValue(num);
                    if (0 == num || sl.check(b, r, c, num)) {
                        cell.setTips(false, 3);
                        rec.push(
                            {
                                row: r,
                                col: c,
                                value: num
                            }
                        );
                    }
                    else {
                        cell.setTips(true, 3);
                    }
                }
            });
        });

        // 清理笔记
        rec.forEach((item) => {
            this.cells.forEach((row, r) => {
                row.forEach((cell, c) => {
                    if (!cell.isPencil(item.value)) {
                        return;
                    }
                    if (item.row == cell.row   // same row
                        || item.col == cell.col // same column
                        || (parseInt(item.row / 3) == parseInt(cell.row / 3) // same box
                            && parseInt(item.col / 3) == parseInt(cell.col / 3))
                    ) {
                        if (item.value == 0) {
                            cell.clearPencil();
                        }
                        else {
                            cell.delPencil(item.value);
                        }
                    }
                })
            });
        });

        this.dump();
    },

    setPencil: function (num) {
        this.cells.forEach(function (row, r) {
            row.forEach(function (cell, c) {
                if (cell.isSelected()) {
                    if (cell.isPencil(num)) {
                        cell.delPencil(num);
                    }
                    else {
                        cell.setPencil(num);

                    }
                }
            });
        });
    },

    clearPencil: function () {
        this.cells.forEach(function (row, r) {
            row.forEach(function (cell, c) {
                if (cell.isSelected()) {
                    cell.clearPencil();
                }
            });
        });
    },

    dump: function () {
        var data = this.sudokuArray();
        for (var r = 0; r < 9; r++) {
            for (var c = 0; c < 9; c++) {
                data[r][c] = this.cells[r][c].dump();
            }
        }

        if (this.history.length != this.historyIndex) {
            this.history.splice(this.historyIndex);
            this.historyIndex = this.history.length;
        }
        this.history.push(data);
        this.historyIndex++;

        if (this.history.length > 100) {
            this.history.shift();
            this.historyIndex--;
        }

        document.getElementById('str').innerHTML = this.getStr();
    },

    undo: function () {
        if (this.historyIndex > 1) {
            this.historyIndex--;
            var data = this.history[this.historyIndex - 1];
            for (var r = 0; r < 9; r++) {
                for (var c = 0; c < 9; c++) {
                    this.cells[r][c].restore(data[r][c]);
                }
            }
        }
    },

    redo: function () {
        if (this.historyIndex < this.history.length) {
            var data = this.history[this.historyIndex];
            for (var r = 0; r < 9; r++) {
                for (var c = 0; c < 9; c++) {
                    this.cells[r][c].restore(data[r][c]);
                }
            }
            this.historyIndex++;
        }
    },

    updateTips: function (r, c) {
        var num = -1;
        if (r >= 0 && c >= 0) {
            num = this.cells[r][c].getValue();
            if (!num) {
                num = -1;
            }
        }

        for (var row = 0; row < 9; row++) {
            for (var col = 0; col < 9; col++) {
                this.cells[row][col].setTips(
                    r == row    // same row
                    || c == col // same column
                    || (parseInt(r / 3) == parseInt(row / 3) && parseInt(c / 3) == parseInt(col / 3)), // same block
                    1 // type
                );

                this.cells[row][col].setTips(this.cells[row][col].getValue() == num, 2);
            }
        }
    },

    showCandidates: function () {
        var d = this.getData();
        for (var row = 0; row < 9; row++) {
            for (var col = 0; col < 9; col++) {
                if (this.cells[row][col].hasPencil()) {
                    continue;
                }
                if (this.cells[row][col].value != 0) {
                    continue;
                }
                var nums = [];
                for (var num = 1; num <= 9; num++) {
                    if (sl.isValid(d, row, col, num)) {
                        this.cells[row][col].setPencil(num);
                    }
                }
            }
        }

    },

    initByStr: function (text) {
        if (!text) {
            text = document.getElementById('sudokuStr').value;
        }
        var d = this.strToSudokuArray(text);
        this.init(d);
    },

    reset: function () {
        var d = this.base;
        this.init(d);
    },

    input: function (key) {
        if (key >= '0' && key <= '9') {
            if (document.getElementById('pencil').checked) {
                this.setPencil(parseInt(key));
            }
            else {
                this.setValue(parseInt(key));
            }
        }
        else if (key == 'Delete') {
            this.setValue(0);
            this.clearPencil();
        }
    },

    numbarBoardEvent: function (event) {
        var div = event.target;
        while (div && !div.classList.contains('game-cell')) {
            div = div.parentNode;
        }
        if (!div) {
            return;
        }
        this.input(div.id.substring(1, 2));
    },
};

sudoku.initByStr('@3!78#4@1=62&95@9!146#21%4!9(235!8$6@2!7@');

//sudoku.solve();
var sm = document.getElementById('selNum').getElementsByClassName('game-cell');
for (var i = 0; i < sm.length; i++) {
    sm[i].addEventListener('click', (e) => sudoku.numbarBoardEvent(e));
    //移动端点击事件
    sm[i].addEventListener('touchstart', (e) => {
        sudoku.numbarBoardEvent(e);
        e.preventDefault();
    });
}

window.addEventListener('keydown', function (event) {
    if (event.key >= '0' && event.key <= '9') {
        sudoku.input(event.key);
    }
    else if (event.key == 'Delete') {
        sudoku.input(event.key);
    }
    else if (event.key == 'Control' || event.key == 'Alt' || event.key == 'Shift') {
        document.getElementById('autoSel').checked = true;
    }
    else if (event.key == 'z' && true == event.ctrlKey) {
        sudoku.undo();
    }
    else if (event.key == 'y' && true == event.ctrlKey) {
        sudoku.redo();
    }
    else {
        console.log(event.key);
    }
});

window.addEventListener('keyup', function (event) {
    if (event.key == 'Control' || event.key == 'Alt' || event.key == 'Shift') {
        document.getElementById('autoSel').checked = false;
    }
});

window.addEventListener('wheel', function (event) {
    document.getElementById('pencil').checked = !document.getElementById('pencil').checked;
});


